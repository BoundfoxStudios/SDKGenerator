#!/bin/bash
set -e
echo ========== BUILDING iOS ==========

Usage="./BuildIOS.sh <target ipa directory path> <path to project> <path to Unreal Engine install>"

archivePath=$1
projectPath=$2
uePath=$3

if [ "$#" -ne 3 ]; then
    echo $usage
    exit 1
fi

# Unreal Version, to change on every unreal version
ueVersion="<%- ueTargetVersion %>"

# Full Path. In theory it should not be edited (the engine path/version are the only ones that should be edited).
uatPath="$uePath/UE_${ueVersion}/Engine/Build/BatchFiles/"

# Target Platform
targetPlatform=iOS

uprojdir="$projectPath/ExampleProject.uproject"

cd "$uatPath"

# The actual build command. To adapt depending on the needs.
# . ./RunUAT.sh -ScriptsForProject="$uprojdir" BuildCookRun -nocompile -editorrecompile -installed -nop4 -project="$uprojdir" -cook -stage -archive -archivedirectory="$archivePath" -package -clientconfig=Development -ue4exe=UE4Editor -pak -prereqs -nodebuginfo -targetplatform=IOS -build -utf8output

# Try 1, doesn't really talk about targeting IOS
#mono AutomationTool.exe -ScriptsForProject="$uprojdir" BuildCookRun -project="$uprojdir" -noP4 -clientconfig=Development -serverconfig=Development -nocompile -nocompileeditor -installed -ue4exe=$uePath

# Try 2, really long, need to find correct folders for the following:
# change to follow the users given Unreal Engine path to the UnrealBuildTool 
# What are the correct folders? Do they correspond correctly with our own Intermediate/Build? Or Manifest?
# Why are we -skipdeploy?ing? will we need to do that after? (we should have this in the automation backend after the fact)
mono "/Users/Shared/Epic Games/UE_4.24/Engine/Binaries/DotNET/UnrealBuildTool.exe" ExampleProject IOS Development -Project=/Users/jenkins/Downloads/ExampleProject/ExampleProject.uproject  /Users/jenkins/pathto/ExampleProject/ExampleProject.uproject -NoUBTMakefiles  -remoteini="/Users/jenkins/pathto/ExampleProject" -skipdeploy -ini:Game:[/Script/UnrealEd.ProjectPackagingSettings]:BlueprintNativizationMethod=Disabled -Manifest=/Users/jenkins/pathto/ExampleProject/Intermediate/Build/Manifest.xml -NoHotReload -log="/Users/jenkins/pathto/Library/Logs/Unreal Engine/LocalBuildLogs/UBT-ExampleProject-IOS-Development.txt"
